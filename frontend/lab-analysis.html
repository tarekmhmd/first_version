<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Results Analysis - Medical AI Assistant</title>
    <meta name="description" content="AI-powered laboratory results analysis - Upload lab reports for instant interpretation">
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar" role="navigation" aria-label="Main navigation">
            <div class="sidebar-header">
                <h2>üè• Medical AI</h2>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html" class="nav-link"><span>üìä</span> Dashboard</a></li>
                    <li class="nav-item"><a href="profile.html" class="nav-link"><span>üë§</span> Profile</a></li>
                    <li class="nav-item"><a href="skin-analysis.html" class="nav-link"><span>üî¨</span> Skin Analysis</a></li>
                    <li class="nav-item"><a href="lab-analysis.html" class="nav-link active" aria-current="page"><span>üß™</span> Lab Results</a></li>
                    <li class="nav-item"><a href="chatbot.html" class="nav-link"><span>üí¨</span> AI Chatbot</a></li>
                    <li class="nav-item"><a href="sound-analysis.html" class="nav-link"><span>üé§</span> Sound Analysis</a></li>
                    <li class="nav-item"><a href="health-records.html" class="nav-link"><span>üìã</span> Health Records</a></li>
                    <li class="nav-item"><a href="about.html" class="nav-link"><span>‚ÑπÔ∏è</span> About Us</a></li>
                    <li class="nav-item"><a href="contact.html" class="nav-link"><span>üìß</span> Contact</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" onclick="logout()"><span>üö™</span> Logout</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content" role="main">
            <header class="header">
                <h1>üß™ Laboratory Results Analysis</h1>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="userName">User</span>
                </div>
            </header>

            <!-- Lab Test Categories -->
            <div class="lab-categories">
                <button class="category-card active" onclick="selectCategory('blood')" id="cat-blood">
                    <span class="category-icon">ü©∏</span>
                    <span class="category-name">Blood Tests</span>
                    <span class="category-desc">CBC, Chemistry, Hormones</span>
                </button>
                <button class="category-card" onclick="selectCategory('urine')" id="cat-urine">
                    <span class="category-icon">üíß</span>
                    <span class="category-name">Urinalysis</span>
                    <span class="category-desc">UA, Culture, Microalbumin</span>
                </button>
                <button class="category-card" onclick="selectCategory('lipid')" id="cat-lipid">
                    <span class="category-icon">üìä</span>
                    <span class="category-name">Lipid Panel</span>
                    <span class="category-desc">Cholesterol, Triglycerides</span>
                </button>
                <button class="category-card" onclick="selectCategory('thyroid')" id="cat-thyroid">
                    <span class="category-icon">üî¨</span>
                    <span class="category-name">Thyroid</span>
                    <span class="category-desc">TSH, T3, T4</span>
                </button>
            </div>

            <!-- Main Analysis Card -->
            <div class="card">
                <div class="lab-tabs">
                    <button class="lab-tab active" onclick="switchLabTab('upload')" id="tab-upload">
                        <span>üì§</span> Upload Report
                    </button>
                    <button class="lab-tab" onclick="switchLabTab('manual')" id="tab-manual">
                        <span>üìù</span> Enter Manually
                    </button>
                    <button class="lab-tab" onclick="switchLabTab('history')" id="tab-history">
                        <span>üìã</span> Past Results
                    </button>
                </div>

                <!-- Upload Tab -->
                <div id="uploadTab" class="lab-tab-content active">
                    <div class="step-header">
                        <h2>Upload Lab Report</h2>
                        <p>Upload a clear image or PDF of your laboratory results</p>
                    </div>

                    <div class="upload-area-enhanced" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">üìÑ</div>
                        <h3>Click or Drag to Upload</h3>
                        <p>Supported formats: JPG, PNG, PDF</p>
                        
                        <div class="upload-requirements">
                            <div class="requirement-item">
                                <span class="requirement-icon">üì∏</span>
                                <span>Clear image</span>
                            </div>
                            <div class="requirement-item">
                                <span class="requirement-icon">üìè</span>
                                <span>All values visible</span>
                            </div>
                            <div class="requirement-item">
                                <span class="requirement-icon">üîç</span>
                                <span>Good lighting</span>
                            </div>
                        </div>

                        <button class="btn btn-primary browse-btn" onclick="event.stopPropagation(); document.getElementById('fileInput').click()">
                            <span>üìÅ</span> Browse Files
                        </button>
                    </div>

                    <input type="file" id="fileInput" class="file-input" accept="image/*,.pdf" onchange="handleFileSelect(event)">

                    <div id="imagePreview" class="image-preview-container hidden">
                        <div class="image-preview-wrapper">
                            <img id="previewImg" class="preview-image" src="" alt="Lab report preview">
                            <button class="btn-change-image" onclick="clearFile()">
                                <span>üîÑ</span> Change File
                            </button>
                        </div>
                        
                        <div class="ocr-status">
                            <div class="ocr-icon">üîç</div>
                            <div class="ocr-text">
                                <h4>AI Text Recognition</h4>
                                <p>Our AI will automatically extract values from your lab report</p>
                            </div>
                        </div>
                    </div>

                    <button id="analyzeBtn" class="btn btn-primary analyze-btn hidden" onclick="analyzeLabReport()">
                        <span>üî¨</span> Analyze Lab Results
                    </button>
                </div>

                <!-- Manual Entry Tab -->
                <div id="manualTab" class="lab-tab-content">
                    <div class="step-header">
                        <h2>Enter Lab Values Manually</h2>
                        <p>Input your laboratory results for AI analysis</p>
                    </div>

                    <div class="manual-entry-form">
                        <div class="test-category">
                            <h3>Complete Blood Count (CBC)</h3>
                            
                            <div class="test-row">
                                <div class="test-info">
                                    <label>WBC</label>
                                    <span class="test-unit">(x10¬≥/¬µL)</span>
                                    <span class="test-range">Normal: 4.5-11.0</span>
                                </div>
                                <input type="number" id="wbc" step="0.1" placeholder="Enter value">
                            </div>

                            <div class="test-row">
                                <div class="test-info">
                                    <label>RBC</label>
                                    <span class="test-unit">(x10‚Å∂/¬µL)</span>
                                    <span class="test-range">Normal: 4.5-5.5</span>
                                </div>
                                <input type="number" id="rbc" step="0.1" placeholder="Enter value">
                            </div>

                            <div class="test-row">
                                <div class="test-info">
                                    <label>Hemoglobin</label>
                                    <span class="test-unit">(g/dL)</span>
                                    <span class="test-range">Normal: 13.5-17.5</span>
                                </div>
                                <input type="number" id="hgb" step="0.1" placeholder="Enter value">
                            </div>

                            <div class="test-row">
                                <div class="test-info">
                                    <label>Hematocrit</label>
                                    <span class="test-unit">(%)</span>
                                    <span class="test-range">Normal: 41-53</span>
                                </div>
                                <input type="number" id="hct" step="0.1" placeholder="Enter value">
                            </div>

                            <div class="test-row">
                                <div class="test-info">
                                    <label>Platelets</label>
                                    <span class="test-unit">(x10¬≥/¬µL)</span>
                                    <span class="test-range">Normal: 150-450</span>
                                </div>
                                <input type="number" id="plt" placeholder="Enter value">
                            </div>
                        </div>

                        <div class="test-category">
                            <h3>Basic Metabolic Panel</h3>
                            
                            <div class="test-row">
                                <div class="test-info">
                                    <label>Glucose</label>
                                    <span class="test-unit">(mg/dL)</span>
                                    <span class="test-range">Normal: 70-99</span>
                                </div>
                                <input type="number" id="glucose" placeholder="Enter value">
                            </div>

                            <div class="test-row">
                                <div class="test-info">
                                    <label>Creatinine</label>
                                    <span class="test-unit">(mg/dL)</span>
                                    <span class="test-range">Normal: 0.6-1.2</span>
                                </div>
                                <input type="number" id="creatinine" step="0.1" placeholder="Enter value">
                            </div>

                            <div class="test-row">
                                <div class="test-info">
                                    <label>BUN</label>
                                    <span class="test-unit">(mg/dL)</span>
                                    <span class="test-range">Normal: 7-20</span>
                                </div>
                                <input type="number" id="bun" placeholder="Enter value">
                            </div>

                            <div class="test-row">
                                <div class="test-info">
                                    <label>Sodium</label>
                                    <span class="test-unit">(mEq/L)</span>
                                    <span class="test-range">Normal: 135-145</span>
                                </div>
                                <input type="number" id="sodium" placeholder="Enter value">
                            </div>

                            <div class="test-row">
                                <div class="test-info">
                                    <label>Potassium</label>
                                    <span class="test-unit">(mEq/L)</span>
                                    <span class="test-range">Normal: 3.5-5.0</span>
                                </div>
                                <input type="number" id="potassium" step="0.1" placeholder="Enter value">
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="analyzeManualEntries()">
                            <span>üìä</span> Analyze Values
                        </button>
                    </div>
                </div>

                <!-- History Tab -->
                <div id="historyTab" class="lab-tab-content">
                    <div class="step-header">
                        <h2>Previous Lab Results</h2>
                        <p>Compare your results over time</p>
                    </div>

                    <div class="history-timeline" id="historyTimeline">
                        <!-- Will be populated by JavaScript -->
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <p>Loading your lab history...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="card hidden">
                <div class="results-header">
                    <h2>üìä Analysis Results</h2>
                    <div class="results-actions">
                        <button class="btn-icon" onclick="printResults()" title="Print">
                            <span>üñ®Ô∏è</span>
                        </button>
                        <button class="btn-icon" onclick="downloadResults()" title="Download">
                            <span>üì•</span>
                        </button>
                        <button class="btn-icon" onclick="shareResults()" title="Share">
                            <span>üì§</span>
                        </button>
                    </div>
                </div>
                
                <div id="labResults" class="lab-results-container">
                    <!-- Results will be injected here -->
                </div>
            </div>

            <!-- Reference Ranges Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìö Reference Ranges</h2>
                    <button class="btn-toggle" onclick="toggleReference()">Show Ranges</button>
                </div>
                
                <div id="referenceRanges" class="reference-ranges hidden">
                    <div class="reference-grid">
                        <div class="reference-category">
                            <h3>Complete Blood Count</h3>
                            <table class="reference-table">
                                <tr><td>WBC</td><td>4.5 - 11.0 x10¬≥/¬µL</td></tr>
                                <tr><td>RBC</td><td>4.5 - 5.5 x10‚Å∂/¬µL</td></tr>
                                <tr><td>Hemoglobin</td><td>13.5 - 17.5 g/dL</td></tr>
                                <tr><td>Hematocrit</td><td>41 - 53%</td></tr>
                                <tr><td>Platelets</td><td>150 - 450 x10¬≥/¬µL</td></tr>
                            </table>
                        </div>
                        
                        <div class="reference-category">
                            <h3>Basic Metabolic Panel</h3>
                            <table class="reference-table">
                                <tr><td>Glucose</td><td>70 - 99 mg/dL</td></tr>
                                <tr><td>Creatinine</td><td>0.6 - 1.2 mg/dL</td></tr>
                                <tr><td>BUN</td><td>7 - 20 mg/dL</td></tr>
                                <tr><td>Sodium</td><td>135 - 145 mEq/L</td></tr>
                                <tr><td>Potassium</td><td>3.5 - 5.0 mEq/L</td></tr>
                            </table>
                        </div>
                        
                        <div class="reference-category">
                            <h3>Lipid Panel</h3>
                            <table class="reference-table">
                                <tr><td>Total Cholesterol</td><td><200 mg/dL</td></tr>
                                <tr><td>HDL</td><td>>40 mg/dL</td></tr>
                                <tr><td>LDL</td><td><100 mg/dL</td></tr>
                                <tr><td>Triglycerides</td><td><150 mg/dL</td></tr>
                            </table>
                        </div>
                        
                        <div class="reference-category">
                            <h3>Thyroid</h3>
                            <table class="reference-table">
                                <tr><td>TSH</td><td>0.4 - 4.0 mIU/L</td></tr>
                                <tr><td>T3</td><td>80 - 200 ng/dL</td></tr>
                                <tr><td>T4</td><td>5 - 12 ¬µg/dL</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <p class="reference-note">‚ö†Ô∏è Reference ranges may vary by laboratory and individual factors</p>
                </div>
            </div>

            <!-- Lab Tips -->
            <div class="card tips-card">
                <div class="tips-header">
                    <span class="tips-icon">üí°</span>
                    <h3>Understanding Your Lab Results</h3>
                </div>
                <ul class="tips-list">
                    <li>üìä Compare results with reference ranges specific to your age and gender</li>
                    <li>üîÑ Single abnormal value doesn't always indicate a problem</li>
                    <li>üìà Track trends over time - they're often more important than single values</li>
                    <li>üíä Inform your doctor about medications that might affect results</li>
                    <li>‚è∞ Fasting requirements vary by test type</li>
                </ul>
            </div>

            <!-- Medical Disclaimer -->
            <div class="card disclaimer-card">
                <div class="disclaimer-content">
                    <span class="disclaimer-icon">‚ö†Ô∏è</span>
                    <div>
                        <strong>Important Medical Disclaimer:</strong>
                        <p>This AI analysis is for educational purposes only. Lab results should always be interpreted by a qualified healthcare professional who knows your complete medical history.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/app.js"></script>
    <script>
        // Check authentication
        checkAuth();

        // Load user info
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        document.getElementById('userName').textContent = user.name || 'User';
        document.getElementById('userAvatar').textContent = (user.name || 'U')[0].toUpperCase();

        // Global variables
        let selectedFile = null;
        let currentCategory = 'blood';
        let currentAnalysisResult = null;

        // Setup drag and drop
        const uploadArea = document.getElementById('uploadArea');
        setupDragAndDrop(uploadArea, handleFile);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            handleFile(file);
        }

        function handleFile(file) {
            if (!file) return;

            const validTypes = ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                showNotification('Please select a valid image or PDF file', 'error');
                return;
            }

            selectedFile = file;

            // Show preview for images
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').classList.remove('hidden');
                    document.getElementById('analyzeBtn').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                // PDF preview
                document.getElementById('previewImg').src = 'https://cdn-icons-png.flaticon.com/512/337/337946.png';
                document.getElementById('imagePreview').classList.remove('hidden');
                document.getElementById('analyzeBtn').classList.remove('hidden');
            }
        }

        function clearFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('analyzeBtn').classList.add('hidden');
            document.getElementById('previewImg').src = '';
        }

        function selectCategory(category) {
            currentCategory = category;
            
            // Update active state
            ['blood', 'urine', 'lipid', 'thyroid'].forEach(cat => {
                const element = document.getElementById(`cat-${cat}`);
                if (cat === category) {
                    element.classList.add('active');
                } else {
                    element.classList.remove('active');
                }
            });
        }

        function switchLabTab(tab) {
            // Update tab buttons
            ['upload', 'manual', 'history'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const content = document.getElementById(`${t}Tab`);
                
                if (t === tab) {
                    btn.classList.add('active');
                    content.classList.add('active');
                } else {
                    btn.classList.remove('active');
                    content.classList.remove('active');
                }
            });

            // Load history if switching to history tab
            if (tab === 'history') {
                loadLabHistory();
            }
        }

        async function analyzeLabReport() {
            if (!selectedFile) {
                showNotification('Please select a file first', 'error');
                return;
            }

            const resultsDiv = document.getElementById('labResults');
            const resultsSection = document.getElementById('resultsSection');
            
            // Show loading
            resultsDiv.innerHTML = `
                <div class="analysis-loading">
                    <div class="spinner"></div>
                    <p>AI is analyzing your lab report...</p>
                    <div class="loading-steps">
                        <div class="loading-step">üìÑ Extracting text from report</div>
                        <div class="loading-step">üî¨ Identifying lab values</div>
                        <div class="loading-step">üìä Comparing with reference ranges</div>
                        <div class="loading-step">üß† Generating interpretation</div>
                    </div>
                </div>
            `;
            
            resultsSection.classList.remove('hidden');

            try {
                const result = await uploadFile('/analyze/lab', selectedFile, 'image');
                currentAnalysisResult = result;
                displayLabResults(resultsDiv, result);
                showNotification('Analysis completed successfully!', 'success');
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="message error">
                        <strong>Error:</strong> ${error.message || 'Analysis failed. Please try again.'}
                    </div>
                `;
                showNotification('Analysis failed. Please try again.', 'error');
            }
        }

        function analyzeManualEntries() {
            const resultsDiv = document.getElementById('labResults');
            const resultsSection = document.getElementById('resultsSection');
            
            // Collect manual entries
            const values = {
                wbc: document.getElementById('wbc')?.value,
                rbc: document.getElementById('rbc')?.value,
                hgb: document.getElementById('hgb')?.value,
                hct: document.getElementById('hct')?.value,
                plt: document.getElementById('plt')?.value,
                glucose: document.getElementById('glucose')?.value,
                creatinine: document.getElementById('creatinine')?.value,
                bun: document.getElementById('bun')?.value,
                sodium: document.getElementById('sodium')?.value,
                potassium: document.getElementById('potassium')?.value
            };

            // Simulate analysis
            resultsDiv.innerHTML = `
                <div class="result-card">
                    <div class="result-header" style="border-left-color: #2A5C9A">
                        <div>
                            <span class="result-badge">Manual Entry Analysis</span>
                            <h3>Laboratory Results Interpretation</h3>
                        </div>
                    </div>

                    <div class="result-body">
                        <div class="result-section">
                            <div class="section-label">Entered Values</div>
                            <table class="values-table">
                                <tr><th>Test</th><th>Value</th><th>Status</th></tr>
                                ${Object.entries(values).filter(([_, v]) => v).map(([test, value]) => {
                                    const status = getTestStatus(test, value);
                                    return `
                                        <tr>
                                            <td>${test.toUpperCase()}</td>
                                            <td>${value}</td>
                                            <td><span class="status-badge status-${status}">${status}</span></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </table>
                        </div>

                        <div class="result-section">
                            <div class="section-label">AI Interpretation</div>
                            <p>Based on the entered values, here's a preliminary interpretation:</p>
                            <ul class="interpretation-list">
                                <li>Most values are within normal ranges</li>
                                <li>Consider consulting a doctor for comprehensive evaluation</li>
                                <li>Repeat testing may be recommended for abnormal values</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            resultsSection.classList.remove('hidden');
            showNotification('Analysis complete', 'success');
        }

        function getTestStatus(test, value) {
            // Simplified status check - in real app, would use proper ranges
            const numValue = parseFloat(value);
            if (isNaN(numValue)) return 'unknown';
            
            // Example ranges - would need proper implementation
            if (numValue < 50) return 'low';
            if (numValue > 150) return 'high';
            return 'normal';
        }

        function displayLabResults(container, result) {
            container.innerHTML = `
                <div class="result-card">
                    <div class="result-header" style="border-left-color: ${getSeverityColor(result.severity)}">
                        <div>
                            <span class="result-badge">AI Analysis Complete</span>
                            <h3>${result.diagnosis || 'Laboratory Analysis'}</h3>
                        </div>
                        <span class="severity-badge severity-${result.severity}">${result.severity?.toUpperCase() || 'NORMAL'}</span>
                    </div>

                    <div class="result-body">
                        ${result.confidence ? `
                        <div class="result-section">
                            <div class="section-label">Analysis Confidence</div>
                            <div class="confidence-meter">
                                <div class="confidence-fill" style="width: ${result.confidence}%"></div>
                                <span class="confidence-value">${result.confidence}%</span>
                            </div>
                        </div>
                        ` : ''}

                        ${result.lab_values && Object.keys(result.lab_values).length > 0 ? `
                        <div class="result-section">
                            <div class="section-label">Detected Lab Values</div>
                            <div class="lab-values-grid">
                                ${Object.entries(result.lab_values).map(([test, value]) => `
                                    <div class="lab-value-item">
                                        <span class="lab-test">${test}</span>
                                        <span class="lab-value">${value}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        <div class="result-section">
                            <div class="section-label">Interpretation</div>
                            <div class="treatment-text">${result.treatment || 'All values are within normal ranges.'}</div>
                        </div>

                        ${result.recommendations && result.recommendations.length > 0 ? `
                        <div class="result-section">
                            <div class="section-label">Recommendations</div>
                            <ul class="recommendations-list">
                                ${result.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}

                        <div class="result-section">
                            <div class="section-label">Follow-up Actions</div>
                            <div class="next-steps">
                                <div class="next-step">
                                    <span class="step-number">1</span>
                                    <span>Discuss results with your doctor</span>
                                </div>
                                <div class="next-step">
                                    <span class="step-number">2</span>
                                    <span>Repeat tests if recommended</span>
                                </div>
                                <div class="next-step">
                                    <span class="step-number">3</span>
                                    <span>Track changes over time</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="result-footer">
                        <p class="analysis-date">Analysis completed: ${new Date().toLocaleString()}</p>
                    </div>
                </div>
            `;
        }

        function getSeverityColor(severity) {
            const colors = {
                'none': '#50C878',
                'mild': '#F39C12',
                'moderate': '#E74C3C',
                'severe': '#C0392B'
            };
            return colors[severity] || '#2A5C9A';
        }

        function loadLabHistory() {
            const timeline = document.getElementById('historyTimeline');
            
            // Simulate loading history
            setTimeout(() => {
                timeline.innerHTML = `
                    <div class="history-item">
                        <div class="history-date">March 15, 2024</div>
                        <div class="history-results">
                            <div class="history-result" onclick="viewHistoricalResult('cbc-001')">
                                <span class="history-type">Complete Blood Count</span>
                                <span class="history-status normal">Normal</span>
                            </div>
                            <div class="history-result" onclick="viewHistoricalResult('lipid-001')">
                                <span class="history-type">Lipid Panel</span>
                                <span class="history-status borderline">Borderline</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="history-item">
                        <div class="history-date">February 1, 2024</div>
                        <div class="history-results">
                            <div class="history-result" onclick="viewHistoricalResult('cbc-002')">
                                <span class="history-type">Complete Blood Count</span>
                                <span class="history-status normal">Normal</span>
                            </div>
                            <div class="history-result" onclick="viewHistoricalResult('basic-001')">
                                <span class="history-type">Basic Metabolic Panel</span>
                                <span class="history-status normal">Normal</span>
                            </div>
                        </div>
                    </div>
                `;
            }, 1000);
        }

        function viewHistoricalResult(id) {
            showNotification('Loading historical result...', 'info');
            // In real app, would load specific historical result
        }

        function toggleReference() {
            const ranges = document.getElementById('referenceRanges');
            const button = event.currentTarget;
            
            ranges.classList.toggle('hidden');
            button.textContent = ranges.classList.contains('hidden') ? 'Show Ranges' : 'Hide Ranges';
        }

        function printResults() {
            window.print();
        }

        function downloadResults() {
            if (!currentAnalysisResult) {
                showNotification('No results to download', 'error');
                return;
            }

            const blob = new Blob([JSON.stringify(currentAnalysisResult, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lab-analysis-${Date.now()}.json`;
            a.click();
            
            showNotification('Results downloaded', 'success');
        }

        function shareResults() {
            showNotification('Share feature coming soon!', 'info');
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>